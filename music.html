<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Track Picker (Supabase)</title>
    <style>
        :root {
            --accent: #e11d48;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #fafafa;
            color: #111;
            margin: 24px;
            font-size: 24px;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 36px;
        }

        .actions {
            margin-bottom: 18px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            cursor: pointer;
            background: #fff;
            font-size: 24px;
            transition: .15s;
        }

        button:hover {
            background: #eee;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        #status {
            font-size: 18px;
            color: #666;
        }

        #list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 10px;
        }

        .item {
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: .15s;
            user-select: none;
        }

        .item:hover {
            border-color: #aaa;
        }

        .item.selected {
            background: var(--accent);
            color: #fff;
            border-color: var(--accent);
        }

        .note {
            color: #666;
            font-size: 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <h1>Music for Project</h1>
    <div class="actions">
        <button id="resetBtn">Reset</button>
        <span class="note">Click a card to toggle red. Selections are saved in Supabase.</span>
        <span id="status" class="hidden"></span>
    </div>

    <div id="list" aria-live="polite"></div>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // ✅ Replace with your own Supabase project URL + anon key
        const SUPABASE_URL = "https://gxaslanfvezjrlrqkjli.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4YXNsYW5mdmV6anJscnFramxpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4MTk4NTgsImV4cCI6MjA3MjM5NTg1OH0.BHPAA7Wpt9kk75pdp17xXAGKt2NtG8yCT4iiWwMy3_g";
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const list = document.getElementById("list");
        const resetBtn = document.getElementById("resetBtn");
        const statusEl = document.getElementById("status");

        function setStatus(msg) {
            if (!msg) { statusEl.classList.add('hidden'); statusEl.textContent = ''; return; }
            statusEl.textContent = msg;
            statusEl.classList.remove('hidden');
        }

        async function loadTracks() {
            setStatus('Loading…');
            list.innerHTML = '';
            const { data: tracks, error } = await supabase
                .from('tracks')
                .select('*')
                .order('title', { ascending: true });

            if (error) {
                console.error('Error loading tracks:', error);
                setStatus('Error loading tracks. Check console.');
                return;
            }

            const frag = document.createDocumentFragment();
            for (const track of tracks) {
                const div = document.createElement('div');
                div.className = 'item' + (track.selected ? ' selected' : '');
                div.dataset.id = track.id;
                div.dataset.selected = String(!!track.selected);
                div.textContent = track.title;
                frag.appendChild(div);
            }
            list.appendChild(frag);
            setStatus('');
        }

        async function toggle(el) {
            if (!el?.classList.contains('item')) return;
            const id = Number(el.dataset.id);
            const isSelected = el.classList.contains('selected');
            const newVal = !isSelected;

            // Optimistic UI
            el.classList.toggle('selected', newVal);
            el.dataset.selected = String(newVal);

            const { error } = await supabase
                .from('tracks')
                .update({ selected: newVal })
                .eq('id', id);

            if (error) {
                console.error('Update failed:', error);
                // revert on error
                el.classList.toggle('selected', isSelected);
                el.dataset.selected = String(isSelected);
                setStatus('Could not save. Try again.');
                return;
            }
        }

        // Event delegation for clicks
        list.addEventListener('click', (e) => {
            const card = e.target.closest('.item');
            toggle(card);
        });

        // Reset all selections
        resetBtn.addEventListener('click', async () => {
            resetBtn.disabled = true;
            setStatus('Resetting…');

            // ✅ Supabase requires a filter on UPDATE; use a catch‑all filter
            const { error } = await supabase
                .from('tracks')
                .update({ selected: false })
                .not('id', 'is', null); // applies to all rows

            if (error) {
                console.error('Reset failed:', error);
                setStatus('Reset failed. Check console.');
                resetBtn.disabled = false;
                return;
            }

            // Repaint UI
            document.querySelectorAll('.item.selected').forEach(el => el.classList.remove('selected'));
            setStatus('All selections cleared.');
            setTimeout(() => setStatus(''), 1500);
            resetBtn.disabled = false;
        });

        // Initial load
        loadTracks();
    </script>
</body>

</html>